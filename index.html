
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Briefing Fdf</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <style>
        :root {
            --sc-red: #e60012;
            --sc-blue: #0a2c5a;
            --sc-yellow: #ffc107;
            --light-bg: #f4f6f9;
            --dark-text: #333;
            --border-color: #e0e0e0;
            --nav-height: 40px;
        }

        html {
            scroll-behavior: smooth;
            scroll-padding-top: var(--nav-height); 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 0 20px 20px 20px;
            color: var(--dark-text);
            background-color: var(--light-bg);
        }

        .main-nav {
            background-color: var(--sc-blue);
            color: white;
            padding: 0 20px;
            width: 100%;
            max-width: 1100px; /* Largeur de la barre de navigation */
            box-sizing: border-box;
            height: var(--nav-height);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #ccc;
            border-top: none;
            border-radius: 0 0 10px 10px;
        }

        .nav-links {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            overflow-x: auto; 
        }

        .nav-links li a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px 12px;
            font-weight: 600;
            font-size: 0.95em;
            white-space: nowrap;
        }

        .nav-links li a:hover {
            /* Effet de survol supprimé */
        }
        
        #gaar-map-nav-link {
            display: none;
        }
        
        .nav-toggle { display: none; }

        /* CORRECTION : Le menu hamburger n'apparaît que sur les écrans très étroits (< 900px) */
        @media (max-width: 900px) {
            .main-nav {
                justify-content: flex-start; /* Aligne les éléments au début pour le menu */
            }
            .nav-toggle {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 1.8em;
                cursor: pointer;
                position: absolute;
                right: 15px;
            }
            .nav-links {
                display: none;
                position: absolute;
                top: var(--nav-height);
                left: 0;
                width: 100%;
                background-color: var(--sc-blue);
                flex-direction: column;
                padding: 10px 0;
            }
            .main-nav.nav-open .nav-links {
                display: flex;
            }
            .nav-links li a {
                padding: 12px 20px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
        }

        #back-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            width: 50px;
            height: 50px;
            background-color: var(--sc-red);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            line-height: 50px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }
        #back-to-top-btn.visible {
            display: block;
            opacity: 1;
        }
        #back-to-top-btn:hover {
            transform: scale(1.1);
        }

        .page-header {
            width: 100%;
            padding: 20px 0 50px 0;
            margin-bottom: 40px;
            position: relative;
        }
        
        .page-header-background {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(155deg, 
                var(--sc-red) 0%, 
                var(--sc-red) 47%, 
                white 47%, 
                white 53%, 
                var(--sc-yellow) 53%, 
                var(--sc-yellow) 100%
            );
            clip-path: polygon(0 0, 100% 0, 100% 75%, 0% 100%);
            z-index: 1;
        }

        #main-title {
            position: relative;
            z-index: 2;
            text-align: center;
            color: #17A2B8;
            font-size: 3em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            margin: 20px 0 10px 0;
            padding: 0 20px;
        }

        #current-time-display {
            position: relative;
            z-index: 2;
            text-align: center;
            color: #000;
            font-size: 2em;
            font-weight: bold;
            margin: 0 0 30px 0;
            text-shadow: none;
        }

        .session-management {
            width: 100%;
            max-width: 980px; /* Largeur du contenu */
            margin: 0 auto 40px auto;
            position: relative;
            z-index: 2;
            padding: 20px;
            background-color: rgba(10, 44, 90, 0.8);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .session-management h3 { margin-top: 0; color: white; }
        .session-management .link-button { margin: 5px 10px; font-size: 1em; padding: 10px 20px; }
        .session-management .link-button:disabled { background-color: #95a5a6; cursor: not-allowed; opacity: 0.7; }
        #session-status { font-style: italic; color: white; opacity: 0.9; margin-top: 15px; font-weight: bold; }
        
        .map-section, .pdf-section, .notam-section {
            width: 100%;
            max-width: 980px; /* Largeur du contenu */
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-top: 5px solid var(--sc-red);
            transition: transform 0.2s ease-out;
        }
        .map-section:hover, .notam-section:hover, .pdf-section:hover {
            transform: translateY(-3px);
        }

        h2 { 
            text-align: center;
            color: var(--sc-blue); 
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-top: 0;
            margin-bottom: 25px;
        }
        
        .carte-container { 
            width: 100%; 
            height: 90vh; 
            border: 1px solid var(--border-color); 
            position: relative; 
            background-color: #e9ecef; 
            border-radius: 8px; 
            overflow: hidden;
        }
        
        .carte-container iframe { width: 100%; height: 100%; border: none; }
        
        #temsi-frame {
            transform: scale(1.25) translate(8%, 8%);
            transform-origin: center;
        }

        .controles, .pdf-controls { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; margin-bottom: 20px; gap: 15px; }
        
        .windy-controls-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 401;
        }
        #windy-controls-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--sc-red);
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .controls-panel { 
            display: none;
            position: absolute;
            top: 50px;
            left: 0;
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            width: max-content;
        }
        .windy-controls-container.open .controls-panel {
            display: flex;
        }
        
        .control-group { 
            display: flex; 
            flex-wrap: wrap;
            justify-content: center;
            align-items: center; 
            gap: 6px; 
            padding: 6px; 
            background-color: #e4e6eb; 
            border-radius: 8px; 
        }
        .control-btn { 
            padding: 6px 12px;
            font-size: 0.85em;
            font-weight: 600; 
            border: none; 
            border-radius: 6px; 
            background-color: #ffffff; 
            color: #333; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .control-btn:hover:not(:disabled) { background-color: #dcdfe4; }
        .control-btn.active { background-color: #007aff; color: white; transform: scale(1.05); }
        .control-btn:disabled { background-color: #f4f4f4; color: #aaa; cursor: not-allowed; border-color: #e0e0e0; }
        .control-label { font-size: 1em; font-weight: bold; color: var(--sc-blue); padding-right: 5px; }


        select, textarea, button, input { font-size: 1em; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        textarea { width: 100%; min-height: 200px; box-sizing: border-box; font-family: monospace; }
        .info-carte, .pdf-info { margin-bottom: 20px; font-size: 1.1em; font-weight: bold; text-align: center; }
        .pdf-info { font-size: 1em; margin-top: 10px; margin-bottom: 0; }
        #pdf-input-fds, #pdf-input-gaar, #pdf-input-notam, #pdf-input-sup-aip { display: none; }
        
        .link-button { display: inline-block; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-size: 1.1em; transition: all 0.2s; cursor: pointer; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .link-button:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        .notam-controls { display: none; justify-content: center; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
        
        #notam-controls-bottom { 
            width: 100%; 
            max-width: 980px; /* Largeur du contenu */
            margin-top: 20px;
            margin-bottom: 0;
            padding: 0 20px; 
            box-sizing: border-box; 
        }

        .confirm-action { background-color: #3498db !important; }
        .confirm-action:hover { background-color: #2980b9 !important; }
        .reset { background-color: #95a5a6; }
        .save-pdf-action { background-color: #8e44ad; }
        
        .notam-pre-filter {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        #keyword-filter-toggle-btn {
            background-color: #7f8c8d;
            color: white;
            padding: 8px 15px;
            font-size: 1em;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .filter-list {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            min-width: 250px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 5px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            right: 0;
        }
        .filter-list label {
            display: block;
            padding: 4px 8px;
            cursor: pointer;
            color: var(--dark-text);
            border-radius: 3px;
            font-weight: normal;
            text-transform: capitalize;
            user-select: none;
        }
        .filter-list label:hover {
            background-color: #f0f0f0;
        }
        .filter-list input {
            margin-right: 8px;
            vertical-align: middle;
        }
        
        #notam-display h3, #manual-metar-display h3 { border-bottom: 2px solid var(--sc-yellow); padding-bottom: 5px; margin-top: 30px; color: var(--sc-blue);}
        
        .notam-item { 
            display: flex;
            gap: 10px;
            align-items: flex-start;
            border-left: 5px solid var(--sc-yellow); 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 4px; 
            transition: background-color 0.2s, border-left-color 0.2s, max-height 0.3s ease-out, opacity 0.3s ease-out; 
            background-color: #f8f9fa;
        }
        .notam-item:has(.notam-checkbox:checked) { 
            border-left-color: #28a745; 
            background-color: #f0fff4; 
        }
        .notam-checkbox {
             margin-top: 2px;
             flex-shrink: 0;
        }
        .notam-content-wrapper {
            flex-grow: 1;
        }
        .notam-validity {
            font-weight: bold;
            margin-bottom: 8px;
        }

        mark.highlighted-text {
            background-color: #ffd700;
            font-weight: bold;
            color: black;
        }

        .sup-aip-item { margin-bottom: 30px; border-top: 2px solid var(--sc-blue); padding-top: 20px; }
        
        .dropzone.drag-over { background-color: #fff8e1; border-color: var(--sc-yellow); border-style: dashed; }
        
        .interactive-pdf-viewer { border: 1px solid var(--border-color); border-radius: 8px; background-color: #e9ecef; overflow: hidden; }
        .pdf-canvas-wrapper { width: 100%; height: 90vh; overflow: auto; cursor: grab; }

        .interactive-pdf-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 8px 10px;
            gap: 15px;
            background-color: #f0f0f0;
            border-bottom: 1px solid var(--border-color);
        }
        .interactive-pdf-controls .pdf-nav-btn {
            padding: 5px 12px;
            font-size: 0.9em;
            background-color: #fff;
            border: 1px solid #ccc;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .interactive-pdf-controls .pdf-nav-btn:hover {
            background-color: #e9e9e9;
        }
        .interactive-pdf-controls > span {
            font-size: 0.9em;
            color: #555;
            font-weight: bold;
        }
        .interactive-pdf-controls .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .interactive-pdf-controls .zoom-controls span {
            font-size: 0.9em;
            color: #555;
        }
        
        .taf-toggle-btn { background-color: var(--sc-blue); color: white; border: none; padding: 5px 10px; font-size: 0.8em; cursor: pointer; border-radius: 4px; margin-left: 10px; vertical-align: middle; }
        .metar-taf-refresh-btn { margin-left: 10px; background: none; border: 1px solid #ccc; cursor: pointer; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; line-height: 22px; vertical-align: middle; padding: 0; }
        .metar-taf-refresh-btn:hover { background-color: #e9ecef; }
        .metar-taf-container { border: 1px solid #e0e0e0; background-color: #fdfdfd; padding: 15px; margin-top: 10px; border-radius: 5px; font-size: 0.9em; }
        .metar-taf-container h4 { margin: 0 0 5px 0; color: var(--sc-blue); font-size: 1em; display: flex; align-items: center; }
        .metar-taf-container pre { white-space: pre-wrap; word-wrap: break-word; font-family: monospace; background-color: #e9ecef; padding: 10px; border-radius: 4px; margin: 0; font-size: 1.2em; }
        .metar-taf-container .error-msg { color: var(--sc-red); font-style: italic; }
        
        .metar-age-display {
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            vertical-align: middle;
        }
        .weather-validity-warning {
            color: var(--sc-red);
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
            padding: 2px 6px;
            border: 1px solid var(--sc-red);
            border-radius: 4px;
        }
        
        #manual-metar-section { margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--sc-blue); }
        #manual-icao-input { width: 70%; max-width: 500px; text-transform: uppercase; }
        
        .hidden-by-filter, .hidden-by-prefilter { 
            display: none !important;
        }

        footer { margin-top: 20px; font-size: 0.9em; color: #666; }

        #gaar-map-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gaar-map-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        #add-manual-circuit-btn.active {
            background-color: #c0392b;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        #gaar-map-display { width: 100%; height: 500px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #gaar-map-display.crosshair-cursor { cursor: crosshair; }
        #gaar-status { margin-top: 15px; font-weight: bold; color: #555; min-height: 20px; text-align: center; }
        .gaar-city-label { background-color: rgba(255, 255, 255, 0.8); border: 1px solid #999; border-radius: 3px; font-size: 10px; font-weight: bold; padding: 2px 5px; box-shadow: none; }
        .gaar-popup-form { display: flex; flex-direction: column; gap: 8px; }
        .gaar-popup-form input { border: 1px solid #ccc; padding: 5px; border-radius: 3px; }
        .gaar-popup-form button { background-color: #007bff; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; }
        .gaar-popup-form .delete-point-btn { background-color: var(--sc-red); }

        .help-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            background-color: var(--sc-blue);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
            transition: transform 0.2s;
        }
        .help-icon:hover {
            transform: scale(1.1);
        }

        .help-tooltip {
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 20px;
            font-size: 0.9em;
            text-align: left;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .help-tooltip h4 {
            margin-top: 0;
            color: var(--sc-blue);
            border-bottom: 1px solid #ffe58f;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        .help-tooltip ol {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .help-tooltip li {
            margin-bottom: 10px;
        }
        .help-tooltip code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            color: var(--sc-red);
            font-weight: bold;
        }

    </style>
</head>
<body>
    <nav class="main-nav" id="main-nav">
        <button class="nav-toggle" id="nav-toggle" aria-label="Menu">&#9776;</button>
        <ul class="nav-links" id="nav-links">
            <li><a href="#fds-section">FDS</a></li>
            <li><a href="#dispo-pelic-section">DISPO AVIONS/PELIC</a></li>
            <li><a href="#gaar-section">GAAR</a></li>
            <li id="gaar-map-nav-link"><a href="#gaar-map-section">Carte GAAR</a></li>
            <li><a href="#risk-maps-section">RISQUES</a></li>
            <li><a href="#temsi-section">TEMSI</a></li>
            <li><a href="#windy-section">WINDY</a></li>
            <li><a href="#notam-section">NOTAMs/METAR</a></li>
            <li><a href="#sup-aip-section">SUP AIP</a></li>
            <li><a href="#synergi-section">SYNERGI</a></li>
            <li><a href="#google-earth-section">GOOGLE EARTH</a></li>
        </ul>
    </nav>

    <div class="page-header">
        <div class="page-header-background"></div>
        <h1 id="main-title">Briefing Fdf</h1>
        <p id="current-time-display"></p>
        <p style="position: relative; z-index: 2; text-align: center; color: #333; font-size: 1em; margin-top: -25px; margin-bottom: 30px;">v0.1</p>
    </div>

    <div class="session-management" id="session-section">
        <h3>Gestion de la Session</h3>
        <button id="save-session-btn" class="link-button" style="background-color: #28a745;">Sauvegarder</button>
        <button id="clear-session-btn" class="link-button" style="background-color: var(--sc-red);">Effacer</button>
        <a href="https://cncasc-app.fr/" target="_blank" class="link-button" style="background-color: #3498db;">CNCASC</a>
        <p id="session-status"></p>
    </div>

    <div id="fds-section" class="pdf-section dropzone">
        <h2>Feuille de Service</h2>
        <div class="pdf-controls">
            <button id="pdf-load-fds-btn" class="link-button" style="background-color: #2980b9;">Charger la Feuille de Service</button>
            <input type="file" id="pdf-input-fds" accept="application/pdf">
        </div>
        <div id="pdf-interactive-container-fds" class="interactive-pdf-viewer" style="display: none;">
            <div class="interactive-pdf-controls"><button class="pdf-nav-btn" data-action="prev">Page Préc.</button><span>Page <span class="page-num">1</span> / <span class="page-count">1</span></span><button class="pdf-nav-btn" data-action="next">Page Suiv.</button><div class="zoom-controls"><button class="pdf-nav-btn" data-action="zoom-out">-</button><span>Zoom</span><button class="pdf-nav-btn" data-action="zoom-in">+</button></div></div>
            <div class="pdf-canvas-wrapper"><canvas id="pdf-canvas-fds" class="pdf-canvas"></canvas></div>
        </div>
        <p id="pdf-info-fds" class="pdf-info"></p>
    </div>

    <div class="map-section" id="dispo-pelic-section">
        <h2>Dispo Avions / Pélicandrome</h2>
        <div class="controles" style="gap: 20px;">
            <a href="http://cncasc-app.fr/pages/ABE.php" target="_blank" class="link-button" style="background-color:#3498db;">Dispo avions</a>
            <a href="https://cncasc-app.fr/pages/pelicandrome.php" target="_blank" class="link-button" style="background-color:#3498db;">Pélicandromes</a>
        </div>
    </div>
    
    <div id="gaar-section" class="pdf-section dropzone">
        <h2>Diagramme GAAR</h2>
        <div class="pdf-controls">
            <button id="pdf-load-gaar-btn" class="link-button" style="background-color: #16a085;">Charger le Diagramme GAAR</button>
            <button id="show-gaar-map-btn" class="link-button" style="background-color: #27ae60;">Carte GAAR</button>
            <button id="pdf-reset-gaar-btn" class="link-button" style="background-color: var(--sc-red); display: none;">Supprimer diagramme GAAR</button>
            <input type="file" id="pdf-input-gaar" accept="application/pdf">
        </div>
        <div id="pdf-interactive-container-gaar" class="interactive-pdf-viewer" style="display: none;">
            <div class="interactive-pdf-controls"><button class="pdf-nav-btn" data-action="prev">Page Préc.</button><span>Page <span class="page-num">1</span> / <span class="page-count">1</span></span><button class="pdf-nav-btn" data-action="next">Page Suiv.</button><div class="zoom-controls"><button class="pdf-nav-btn" data-action="zoom-out">-</button><span>Zoom</span><button class="pdf-nav-btn" data-action="zoom-in">+</button></div></div>
            <div class="pdf-canvas-wrapper"><canvas id="pdf-canvas-gaar" class="pdf-canvas"></canvas></div>
        </div>
        <p id="pdf-info-gaar" class="pdf-info"></p>
    </div>
    
    <div class="map-section" id="gaar-map-section" style="display: none;">
        <h2>Carte des Circuits GAAR</h2>
        <div id="gaar-map-container">
            <div id="gaar-map-controls">
                <button id="add-manual-circuit-btn" class="link-button" style="background-color: #27ae60;">Ajout manuel circuit(s) GAAR</button>
                <button id="delete-circuits-btn" class="link-button" style="background-color: var(--sc-red); display: none;">Supprimer circuit(s) GAAR</button>
            </div>
            <div id="gaar-map-display"></div>
            <div id="gaar-status">Préparez vos circuits sur la carte</div>
        </div>
    </div>

    <div class="map-section" id="risk-maps-section">
        <h2>Carte des risques</h2>
        <div class="controles" style="gap: 20px;">
            <a href="http://www.meteo.fr/extranets/proxy/index/affiche/id/298186" target="_blank" class="link-button" style="background-color: #f39c12;">Carte des Risques / National</a>
            <a href="http://www.meteo.fr/extranets/proxy/index/affiche/id/305344" target="_blank" class="link-button" style="background-color: #e67e22;">Carte des Risques / Zone Sud</a>
        </div>
    </div>
    
    <div class="map-section" id="temsi-section"><h2>Carte SIGWX France (TEMSI)</h2><div class="controles"><label for="temsi-select">Choisir une échéance :</label><select id="temsi-select"></select></div><p class="info-carte" id="temsi-info-carte">Chargement...</p><div class="carte-container"><iframe id="temsi-frame" title="Carte SIGWX France"></iframe></div></div>
    
    <div class="map-section" id="windy-section">
        <h2>WINDY</h2>
        <div style="text-align:center; margin-bottom: 25px;">
            <a href="https://www.windy.com" class="link-button" style="background-color: #16a085;" target="_blank">Ouvrir Windy</a>
        </div>
        <div id="windy-container" class="carte-container">
            <div class="windy-controls-container" id="windy-controls-container">
                <button id="windy-controls-toggle" title="Afficher les contrôles Windy">&#9881;</button>
                <div class="controls-panel">
                    <div class="control-group">
                        <button class="control-btn overlay-btn" data-overlay="drought40" data-product="drought">Sécheresse</button>
                        <button class="control-btn overlay-btn" data-overlay="radar" data-product="radar">Radar</button>
                        <button class="control-btn overlay-btn" data-overlay="satellite" data-product="satellite">Satellite</button>
                        <button class="control-btn overlay-btn" data-overlay="thunder" data-product="ecmwf">Orages</button>
                    </div>
                    <div class="control-group">
                        <button class="control-btn model-btn active" data-model="arome">AROME</button>
                        <button class="control-btn model-btn" data-model="ecmwf">ECMWF</button>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Vent:</span>
                        <button class="control-btn altitude-btn active" data-level="surface">SFC</button>
                        <button class="control-btn altitude-btn" data-level="100m">330ft</button>
                        <button class="control-btn altitude-btn" data-level="925h">2500ft</button>
                        <button class="control-btn altitude-btn" data-level="850h">5000ft</button>
                        <button class="control-btn altitude-btn" data-level="700h">FL100</button>
                    </div>
                </div>
            </div>
            <!-- L'iframe sera insérée ici par JavaScript -->
        </div>
    </div>

    <div id="notam-pdf-dropzone" class="pdf-section dropzone">
        <h2>Importation NOTAMs</h2>
        <div class="pdf-controls">
            <span id="nats-help-icon" class="help-icon" title="Comment utiliser NATS ?">?</span>
            <a href="https://nats-uk.ead-it.com/fwf-nats/restricted/user/ino/brief_aerodrome.faces?menuId=C920E9BB76441A9AE05341741DC25BDD" target="_blank" class="link-button" style="background-color: #8e44ad;">Accéder au Briefing NATS</a>
            <button id="pdf-load-notam-btn" class="link-button" style="background-color: #2c3e50;">Importation NOTAMs</button>
            <input type="file" id="pdf-input-notam" accept="application/pdf">
        </div>
        
        <div id="nats-help-tooltip" class="help-tooltip" style="display: none;">
            <h4>Tutoriel : Récupérer les NOTAMs sur NATS</h4>
            <ol>
                <li>
                    Connectez-vous sur le site NATS avec les identifiants suivants :
                    <ul style="margin-top: 8px;">
                        <li><strong>Login :</strong> <code>Dash8</code></li>
                        <li><strong>Mot de Passe :</strong> <code>D@sh8secucivile</code></li>
                    </ul>
                </li>
                <li>Cliquez sur <strong>Pre-Flight Briefing</strong>.</li>
                <li>Puis sur <strong>Aerodrome PIB</strong>.</li>
                <li>
                    Sous "Briefing Options", trouvez les 4 petits boutons. Cliquez sur celui avec une <strong>étoile (favoris)</strong>, qui se trouve à droite du bouton <strong>+</strong>.
                </li>
                <li>Dans la liste qui apparaît, cliquez sur <strong>PELICANDROMES</strong>.</li>
                <li>Tout en bas de la page, cliquez sur le bouton <strong>Generate</strong>.</li>
                <li>Enfin, cliquez sur <strong>Print PDF</strong> pour télécharger le fichier.</li>
                <li>Enregistrez le PDF sur votre appareil, puis chargez-le sur cette page à l'aide du bouton "Charger PDF des NOTAMs".</li>
            </ol>
        </div>
        
        <p id="pdf-info-notam" class="pdf-info"></p>
    </div>
    
    <div class="notam-section" id="notam-section">
        <h2>Analyse des NOTAMs et Météo</h2>
        <div id="notam-input-area" style="display: none;">
            <p style="text-align:center; margin-bottom:15px;">Chargez un PDF de NOTAMs pour extraire automatiquement le texte, ou collez un bulletin manuellement.</p>
            <textarea id="notam-input" placeholder="Le texte des NOTAMs apparaîtra ici..."></textarea>
            <div style="text-align:center; padding-top: 20px;"><button id="notam-parse-btn" class="link-button" style="background-color: #d35400;">Analyser le texte</button></div>
        </div>
        
        <div class="notam-pre-filter">
            <div>
                <input type="checkbox" id="notam-date-filter-cb" checked>
                <label for="notam-date-filter-cb">Afficher uniquement les NOTAMs valides aujourd'hui</label>
            </div>
            <div class="filter-dropdown">
                <button id="keyword-filter-toggle-btn">Filtres par Mots-Clés</button>
                <div id="keyword-filter-list" class="filter-list" style="display: none;">
                    <!-- Rempli dynamiquement par JS -->
                </div>
            </div>
            <button id="manual-load-weather-btn" class="link-button" style="background-color: #16a085; padding: 8px 15px; font-size: 1em;">Charger Météo</button>
        </div>
        
        <div id="notam-controls-top" class="notam-controls">
            <button class="link-button confirm-action filter-action">Garder la sélection</button>
            <button class="link-button reset show-all-action" style="display: none;">Tout afficher</button>
            <button class="link-button save-pdf-action" style="display: none;">Sauvegarder en PDF</button>
        </div>
        <div id="notam-display"></div>
        <div id="notam-controls-bottom" class="notam-controls">
            <button class="link-button confirm-action filter-action">Garder la sélection</button>
            <button class="link-button reset show-all-action" style="display: none;">Tout afficher</button>
            <button class="link-button save-pdf-action" style="display: none;">Sauvegarder en PDF</button>
        </div>

        <div id="manual-metar-section">
            <h2>Météo Manuelle</h2>
            <div class="controles">
                <input type="text" id="manual-icao-input" placeholder="Entrez les OACI (ex: LFPB EGLL)...">
                <button id="manual-metar-fetch-btn" class="link-button" style="background-color: #16a085;">Obtenir METAR/TAF</button>
            </div>
            <div id="manual-metar-display"></div>
        </div>
    </div>

    <div class="map-section">
        <h2>Carte AZBA</h2>
        <div style="text-align:center;">
            <a href="https://www.sia.aviation-civile.gouv.fr/schedules" target="_blank" class="link-button" style="background-color: #2c3e50;">Ouvrir AZBA</a>
        </div>
    </div>
    
    <div id="sup-aip-section" class="pdf-section dropzone">
        <h2>SUP AIP</h2>
        <div id="sup-aip-controls" class="pdf-controls">
            <a id="foreflight-btn" href="foreflightmobile://" class="link-button" style="background-color: #007aff;">Ouvrir ForeFlight</a>
            <button id="pdf-load-sup-aip-btn" class="link-button" style="background-color: #c0392b;">Charger SUP AIP</button>
            <button id="pdf-add-sup-aip-btn" class="link-button" style="display: none; background-color: #c0392b;">+</button>
        </div>
        <div id="sup-aip-container"></div>
        <input type="file" id="pdf-input-sup-aip" accept="application/pdf" multiple>
    </div>

    <div class="map-section" id="synergi-section">
        <h2>SYNERGI / CNCASC</h2>
        <div class="controles">
            <a href="https://synergi2.dgscgc.interieur.gouv.fr/evenements?forInit=false&statusEvent=PUBLIC" target="_blank" class="link-button" style="background-color:#16a085;">Ouvrir SYNERGI</a>
            <a href="https://cncasc-app.fr/pages/landing.php" target="_blank" class="link-button" style="background-color:#3498db;">Ouvrir CNCASC</a>
        </div>
    </div>

    <div class="map-section" id="google-earth-section">
        <h2>Google Earth</h2>
        <div style="text-align:center;">
            <a href="googleearth://" class="link-button" style="background-color: #4285F4;">Ouvrir Google Earth</a>
        </div>
    </div>
    
    <div style="text-align: center; margin: 40px 0 20px 0;">
        <button id="save-session-btn-bottom" class="link-button" style="background-color: #28a745;">Sauvegarder la session</button>
    </div>
    
    <button id="back-to-top-btn" title="Retour en haut">&#8679;</button>

    <footer>Données : Météo-France, SIA, Windy.com, CheckWX.com. Page non commerciale, à usage personnel.</footer>
    
    <script>
        // --- Clé API pour la source de données météo ---
        const CHECKWX_API_KEY = "f96766a799024b5781b192257de10684";

        // --- GLOBAL VARIABLES ---
        let fdsFileObject = null;
        let gaarFileObject = null;
        let supAipFileObjects = [];
        let gaarMap = null;
        let gaarDrawnCircuits = [];
        let isAddingManualCircuit = false;
        let isSavingSession = false;
        const manualCircuitColors = ['#ff00ff', '#00ffff', '#ff8c00', '#00ff00', '#ff1493'];

        // --- CORE INITIALIZATION ---
        function waitForPdfJsAndInitialize() {
            if (window.pdfjsLib) {
                initializePage();
            } else {
                setTimeout(waitForPdfJsAndInitialize, 100);
            }
        }
        window.onload = waitForPdfJsAndInitialize;
        
        function initializePage() {
            window.scrollTo(0, 0);
            initializeNavigation(); 
            initializePageTitle();
            initializeTemsi();
            initializeWindy();
            initializeInteractivePdfViewers();
            initializeSupAipLoader();
            initializeNotamParser(); 
            initializeManualMetarFetch();
            initializeForeFlightButton();
            initializeSessionManagement();
            initializeHelpTooltips();
            initializeGaarMapControls();
            setInterval(checkWeatherValidity, 60000); // Vérifie la validité des METARs et TAFs chaque minute
        }
        
        function initializeNavigation() {
            const nav = document.getElementById('main-nav');
            const navToggle = document.getElementById('nav-toggle');
            const navLinksContainer = document.getElementById('nav-links');
            const navLinks = navLinksContainer.querySelectorAll('a');
            const backToTopBtn = document.getElementById('back-to-top-btn');

            navToggle.addEventListener('click', () => {
                nav.classList.toggle('nav-open');
            });

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    nav.classList.remove('nav-open');
                    
                    const targetId = link.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);
                    if (!targetSection) return;

                    let customTarget = targetSection;
                    if (targetId === 'windy-section' || targetId === 'temsi-section') {
                        customTarget = document.getElementById(targetId).querySelector('.carte-container');
                    } else if (targetId === 'fds-section') {
                        const pdfContainer = document.getElementById('pdf-interactive-container-fds');
                        if (pdfContainer.style.display !== 'none') customTarget = pdfContainer;
                    } else if (targetId === 'gaar-section') {
                        const pdfContainer = document.getElementById('pdf-interactive-container-gaar');
                        if (pdfContainer.style.display !== 'none') customTarget = pdfContainer;
                    }

                    if (customTarget) {
                        e.preventDefault();
                        const targetPosition = customTarget.getBoundingClientRect().top + window.pageYOffset - (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--nav-height')) || 40);
                        window.scrollTo({ top: targetPosition, behavior: 'smooth' });
                    }
                });
            });

            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            }, { passive: true });
        }

        function initializeWindy() {
            const container = document.getElementById('windy-container');
            const controlsContainer = document.getElementById('windy-controls-container');
            const controlsToggle = document.getElementById('windy-controls-toggle');
            const controlsPanel = controlsContainer.querySelector('.controls-panel');
            
            const modelButtons = controlsPanel.querySelectorAll('.model-btn');
            const altitudeButtons = controlsPanel.querySelectorAll('.altitude-btn');
            const overlayButtons = controlsPanel.querySelectorAll('.overlay-btn');

            controlsToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                controlsContainer.classList.toggle('open');
            });

            document.addEventListener('click', (e) => {
                if (!controlsContainer.contains(e.target)) {
                    controlsContainer.classList.remove('open');
                }
            });

            controlsPanel.addEventListener('click', (e) => {
                if (e.target.matches('.overlay-btn')) {
                    setTimeout(() => controlsContainer.classList.remove('open'), 150);
                }
            });

            function renderWindyMap() {
                const activeModel = controlsPanel.querySelector('.model-btn.active').dataset.model;
                const activeAltitudeBtn = controlsPanel.querySelector('.altitude-btn.active');
                const activeOverlayBtn = controlsPanel.querySelector('.overlay-btn.active');
                
                const baseURL = "https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=mm&metricTemp=°C&metricWind=kt&zoom=6&lat=46.934&lon=2.49";
                let params = "";

                if (activeAltitudeBtn) {
                    params = `&overlay=wind&product=${activeModel}&level=${activeAltitudeBtn.dataset.level}`;
                } else if (activeOverlayBtn) {
                    const product = activeOverlayBtn.dataset.product || activeModel;
                    params = `&overlay=${activeOverlayBtn.dataset.overlay}&product=${product}`;
                }
                
                const newSrc = baseURL + params;
                
                let iframe = container.querySelector('iframe');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.title = "Carte Windy";
                    container.appendChild(iframe);
                }
                iframe.src = newSrc;
            }

            function manageAltitudeButtonsState(selectedModel) {
                const isArome = selectedModel === 'arome';
                let needsReset = false;

                altitudeButtons.forEach(btn => {
                    const isInvalidForArome = isArome && btn.dataset.level !== 'surface';
                    btn.disabled = isInvalidForArome;
                    if (btn.classList.contains('active') && btn.disabled) {
                        btn.classList.remove('active');
                        needsReset = true;
                    }
                });

                if (needsReset) {
                    const surfaceBtn = controlsPanel.querySelector('.altitude-btn[data-level="surface"]');
                    if(surfaceBtn) surfaceBtn.classList.add('active');
                }
            }

            modelButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('active')) return;
                    modelButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    manageAltitudeButtonsState(button.dataset.model);
                    renderWindyMap();
                });
            });

            altitudeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('active') || button.disabled) return;

                    overlayButtons.forEach(btn => btn.classList.remove('active'));
                    altitudeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    const selectedLevel = button.dataset.level;
                    const activeModelBtn = controlsPanel.querySelector('.model-btn.active');
                    let activeModel = activeModelBtn.dataset.model;

                    if (selectedLevel !== 'surface' && activeModel === 'arome') {
                        activeModelBtn.classList.remove('active');
                        const ecmwfBtn = controlsPanel.querySelector('.model-btn[data-model="ecmwf"]');
                        if (ecmwfBtn) {
                            ecmwfBtn.classList.add('active');
                            activeModel = 'ecmwf';
                        }
                    }
                    
                    manageAltitudeButtonsState(activeModel);
                    renderWindyMap();
                });
            });

            overlayButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('active')) return;
                    
                    altitudeButtons.forEach(btn => btn.classList.remove('active'));
                    overlayButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    const requiredModel = button.dataset.product;
                    const isModelSpecific = ['ecmwf', 'arome'].includes(requiredModel);

                    if (isModelSpecific) {
                        modelButtons.forEach(btn => btn.classList.remove('active'));
                        const modelToActivate = controlsPanel.querySelector(`.model-btn[data-model="${requiredModel}"]`);
                        if (modelToActivate) {
                            modelToActivate.classList.add('active');
                            manageAltitudeButtonsState(requiredModel);
                        }
                    }
                    
                    renderWindyMap();
                });
            });

            manageAltitudeButtonsState(controlsPanel.querySelector('.model-btn.active').dataset.model);
            renderWindyMap();
        }

        function initializeHelpTooltips() {
            const icon = document.getElementById('nats-help-icon');
            const tooltip = document.getElementById('nats-help-tooltip');
            if (!icon || !tooltip) return;
            icon.addEventListener('click', () => { tooltip.style.display = (tooltip.style.display === 'none') ? 'block' : 'none'; });
        }

        function createAirportSectionElement(icao, fullName) {
            const airportContainer = document.createElement('div');
            airportContainer.id = `notam-container-${icao}`;
            airportContainer.className = 'airport-section-container';
            airportContainer.dataset.icao = icao;

            const airportTitle = document.createElement('h3');
            airportTitle.textContent = `${fullName} `;

            const tafToggleButton = document.createElement('button');
            tafToggleButton.textContent = 'Afficher TAF';
            tafToggleButton.className = 'taf-toggle-btn';
            tafToggleButton.dataset.icao = icao;

            const refreshButton = document.createElement('button');
            refreshButton.className = 'metar-taf-refresh-btn';
            refreshButton.dataset.icao = icao;
            refreshButton.title = 'Rafraîchir';
            refreshButton.innerHTML = '↻';

            airportTitle.appendChild(tafToggleButton);
            airportTitle.appendChild(refreshButton);

            const metarContainer = document.createElement('div');
            metarContainer.className = 'metar-container metar-taf-container';
            metarContainer.innerHTML = '<h4>METAR</h4><p><i>En attente du chargement manuel.</i></p>';

            const tafContainer = document.createElement('div');
            tafContainer.className = 'taf-container metar-taf-container';
            tafContainer.style.display = 'none';
            tafContainer.innerHTML = '<h4>TAF</h4><p><i>En attente du chargement manuel.</i></p>';

            airportContainer.appendChild(airportTitle);
            airportContainer.appendChild(metarContainer);
            airportContainer.appendChild(tafContainer);
            return airportContainer;
        }


        function createNotamItemElement(notamText, icao) {
            const validity = parseNotamValidity(notamText);
            const itemContainer = document.createElement('div');
            itemContainer.className = 'notam-item';
            if (validity.start) itemContainer.dataset.startDate = validity.start.toISOString();
            if (validity.end) itemContainer.dataset.endDate = validity.end.toISOString();

            const firstLine = notamText.split('\n')[0];
            const notamNumberMatch = firstLine.match(/([A-Z]\d{4}\/\d{2})$/);
            const notamNumber = notamNumberMatch ? notamNumberMatch[1].replace('/', '-') : null;

            if (notamNumber) {
                itemContainer.dataset.notamId = `${icao}-${notamNumber}`;
            } else {
                const bMatch = notamText.match(/B\)\s*(\d{10})/);
                const cMatch = notamText.match(/C\)\s*(\d{10}|PERM)/);
                if (bMatch && cMatch) {
                    itemContainer.dataset.notamId = `${icao}-${bMatch[1]}-${cMatch[1]}`;
                }
            }

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'notam-checkbox';
            itemContainer.appendChild(checkbox);

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'notam-content-wrapper';
            
            if (validity.text) {
                const validityElement = document.createElement('div');
                validityElement.className = 'notam-validity';
                validityElement.textContent = validity.text;
                contentWrapper.appendChild(validityElement);
            }
            
            const textElement = document.createElement('div');
            textElement.className = 'notam-text-content';
            const supAipRegex = /(AIP\s+)?SUP\s+(\d{1,3})\/(\d{2})/gi;
            let linkifiedText = notamText.replace(supAipRegex, (match, p1, supNumber, twoDigitYear) => {
                const fullYear = `20${twoDigitYear}`;
                const paddedNumber = supNumber.padStart(3, '0');
                const baseUrl = "https://www.sia.aviation-civile.gouv.fr/media/store/documents/file/l/f/";
                const pdfUrl = (fullYear === '2025') ? `${baseUrl}lf_sup_a_${fullYear}_${paddedNumber}_fr.pdf` : `${baseUrl}lf_sup_${fullYear}_${paddedNumber}_fr.pdf`;
                return `<a href="${pdfUrl}" class="sup-aip-link" target="_blank" title="Ouvrir le PDF du SUP AIP ${match}">${match}</a>`;
            });
            textElement.innerHTML = linkifiedText.replace(/\s+([B-G]\))/g, '<br>$1');
            contentWrapper.appendChild(textElement);
            itemContainer.appendChild(contentWrapper);
            return itemContainer;
        }

        function parseNotamValidity(notamBlock) {
            let bMatch = notamBlock.match(/B\)\s*(\d{10})/);
            let cMatch = notamBlock.match(/C\)\s*(\d{10}|PERM)/);
            if (bMatch && cMatch) {
                const s = bMatch[1], e = cMatch[1];
                const start = new Date(Date.UTC(parseInt(`20${s.substring(0, 2)}`), parseInt(s.substring(2, 4)) - 1, parseInt(s.substring(4, 6)), parseInt(s.substring(6, 8)), parseInt(s.substring(8, 10))));
                const end = e === 'PERM' ? new Date('2099-12-31T23:59:59Z') : new Date(Date.UTC(parseInt(`20${e.substring(0, 2)}`), parseInt(e.substring(2, 4)) - 1, parseInt(e.substring(4, 6)), parseInt(e.substring(6, 8)), parseInt(e.substring(8, 10))));
                const validityText = `VALIDE DU ${s.substring(4,6)}/${s.substring(2,4)}/${`20${s.substring(0,2)}`} à ${s.substring(6,8)}h${s.substring(8,10)} AU ${e === 'PERM' ? 'PERMANENT' : `${e.substring(4,6)}/${e.substring(2,4)}/${`20${e.substring(0,2)}`} à ${e.substring(6,8)}h${e.substring(8,10)}`}`;
                return { start, end, text: validityText };
            }
            return { text: null, start: null, end: null };
        }
        
        async function fetchAndDisplayWeather(icao, airportContainer) {
            const metarContainer = airportContainer.querySelector('.metar-container');
            const tafContainer = airportContainer.querySelector('.taf-container');

            if (!metarContainer || !tafContainer) return;

            metarContainer.innerHTML = '<h4>METAR</h4><p>Chargement...</p>';
            tafContainer.innerHTML = '<h4>TAF</h4><p>Chargement...</p>';

            if (!CHECKWX_API_KEY) {
                const errorHtml = `<p class="error-msg">Erreur : Clé API non configurée.</p>`;
                metarContainer.innerHTML = `<h4>METAR</h4>${errorHtml}`;
                tafContainer.innerHTML = `<h4>TAF</h4>${errorHtml}`;
                return;
            }

            const headers = { 'X-API-Key': CHECKWX_API_KEY };
            try {
                const [metarResponse, tafResponse] = await Promise.all([
                    fetch(`https://api.checkwx.com/metar/${icao}`, { headers }),
                    fetch(`https://api.checkwx.com/taf/${icao}`, { headers })
                ]);
                
                if (metarResponse.status === 429 || tafResponse.status === 429) {
                    const errorHtml = `<p class="error-msg">Limite de requêtes API Météo atteinte. Réessayez plus tard.</p>`;
                    metarContainer.innerHTML = `<h4>METAR</h4>${errorHtml}`;
                    tafContainer.innerHTML = `<h4>TAF</h4>${errorHtml}`;
                    return;
                }

                const metarJson = await metarResponse.json();
                const tafJson = await tafResponse.json();

                const metarDisplay = (metarJson.results > 0) ? metarJson.data[0] : 'METAR non disponible.';
                const tafDisplay = (tafJson.results > 0) ? tafJson.data[0] : 'TAF non disponible.';

                metarContainer.innerHTML = `<h4>METAR</h4><pre>${metarDisplay}</pre>`;
                tafContainer.innerHTML = `<h4>TAF</h4><pre>${tafDisplay}</pre>`;
                airportContainer.dataset.loaded = 'true';
                checkWeatherValidity(); // Vérifier la validité immédiatement après le chargement

            } catch (error) {
                const errorHtml = `<p class="error-msg">Une erreur de réseau est survenue.</p>`;
                metarContainer.innerHTML = `<h4>METAR</h4>${errorHtml}`;
                tafContainer.innerHTML = `<h4>TAF</h4>${errorHtml}`;
            }
        }
        
        function setupDropzone(zoneId, fileHandlerFunction) {
            const dropzone = document.getElementById(zoneId);
            if (!dropzone) return;
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('drag-over'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) fileHandlerFunction(e.dataTransfer.files);
            });
        }
        
        function initializeTemsi() {
             function populateTemsi() {
                const select = document.getElementById('temsi-select');
                const frame = document.getElementById('temsi-frame');
                const info = document.getElementById('temsi-info-carte');
                select.innerHTML = '';
                const echeances = [6, 9, 12, 15, 18, 21];
                const now = new Date();
                const currentHour = now.getUTCHours();
                const date = new Date(now);
                let activeEcheance = [...echeances].reverse().find(e => currentHour >= e - 1);
                if (activeEcheance === undefined) {
                    activeEcheance = 21;
                    date.setUTCDate(date.getUTCDate() - 1);
                }
                date.setUTCHours(activeEcheance, 0, 0, 0);
                let initialEcheance = '';
                for (let i = -3; i <= 4; i++) { 
                    let echeanceDate = new Date(date);
                    let echeanceIndex = echeances.indexOf(activeEcheance) + i;
                    echeanceDate.setUTCDate(echeanceDate.getUTCDate() + Math.floor(echeanceIndex / echeances.length));
                    echeanceIndex = (echeanceIndex % echeances.length + echeances.length) % echeances.length;
                    echeanceDate.setUTCHours(echeances[echeanceIndex], 0, 0, 0);
                    const dateString = `${echeanceDate.getUTCFullYear()}${String(echeanceDate.getUTCMonth()+1).padStart(2, '0')}${String(echeanceDate.getUTCDate()).padStart(2, '0')}${String(echeanceDate.getUTCHours()).padStart(2, '0')}0000`;
                    const option = document.createElement("option");
                    option.value = dateString;
                    let label = `${getLabelForDate(echeanceDate)} ${String(echeanceDate.getUTCHours()).padStart(2, '0')}h00 UTC`;
                    if (i === 0) {
                        label += " (Actuelle)";
                        option.selected = true;
                        initialEcheance = dateString;
                    }
                    option.textContent = label;
                    select.appendChild(option);
                }
                const baseURL = 'https://aviation.meteo.fr/FR/aviation/affiche_image.php?login=fampsLSMuYmAdrAK4GqcZWRol2hoZHHd1uE%3D&layer=sigwx/fr/france&echeance=';
                const update = e => { frame.src = baseURL + e; info.textContent = `Carte valide pour le ${e.substring(6,8)}/${e.substring(4,6)}/${e.substring(0,4)} à ${e.substring(8,10)}h00 UTC`; };
                select.addEventListener('change', e => update(e.target.value));
                update(initialEcheance);
            }
            populateTemsi();
        }

        function createInteractivePdfHandler(viewerContainer, file, callback, initialScale = 1.5) {
            const canvas = viewerContainer.querySelector('.pdf-canvas');
            const controls = viewerContainer.querySelector('.interactive-pdf-controls');
            const wrapper = viewerContainer.querySelector('.pdf-canvas-wrapper');
            const ctx = canvas.getContext('2d');
            let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null, scale = initialScale;
            let isPanning = false, panStart = { x: 0, y: 0 };
            let initialPinchDistance = null, startScale = null;

            function getDistance(t1, t2) { const dx = t1.clientX - t2.clientX, dy = t1.clientY - t2.clientY; return Math.sqrt(dx * dx + dy * dy); }
            function renderPage(num) {
                pageRendering = true;
                pdfDoc.getPage(num).then(page => {
                    const pixelRatio = Math.max(window.devicePixelRatio || 1, 2);
                    const viewport = page.getViewport({ scale: scale * pixelRatio });
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    canvas.style.height = `${viewport.height / pixelRatio}px`; canvas.style.width = `${viewport.width / pixelRatio}px`;
                    page.render({ canvasContext: ctx, viewport: viewport }).promise.then(() => {
                        pageRendering = false;
                        if (pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
                    });
                });
                controls.querySelector('.page-num').textContent = num;
            }
            function queueRenderPage(num) { if (pageRendering) pageNumPending = num; else renderPage(num); }
            controls.addEventListener('click', e => {
                if (!pdfDoc || !e.target.dataset.action) return;
                const action = e.target.dataset.action;
                if (action === 'prev' && pageNum > 1) { pageNum--; queueRenderPage(pageNum); }
                else if (action === 'next' && pageNum < pdfDoc.numPages) { pageNum++; queueRenderPage(pageNum); }
                else if (action === 'zoom-in') { scale = Math.min(5.0, scale + 0.2); queueRenderPage(pageNum); }
                else if (action === 'zoom-out') { scale = Math.max(0.3, scale - 0.2); queueRenderPage(pageNum); }
            });
            wrapper.addEventListener('wheel', e => { e.preventDefault(); scale = e.deltaY < 0 ? Math.min(5.0, scale + 0.1) : Math.max(0.3, scale - 0.1); queueRenderPage(pageNum); });
            wrapper.addEventListener('mousedown', e => { isPanning = true; panStart = { x: e.clientX + wrapper.scrollLeft, y: e.clientY + wrapper.scrollTop }; });
            wrapper.addEventListener('mouseup', () => isPanning = false);
            wrapper.addEventListener('mouseleave', () => isPanning = false);
            wrapper.addEventListener('mousemove', e => { if (isPanning) { e.preventDefault(); wrapper.scrollLeft = panStart.x - e.clientX; wrapper.scrollTop = panStart.y - e.clientY; } });
            wrapper.addEventListener('touchstart', e => {
                if (e.touches.length === 2) { e.preventDefault(); isPanning = false; initialPinchDistance = getDistance(e.touches[0], e.touches[1]); startScale = scale; }
                else if (e.touches.length === 1) { isPanning = true; panStart = { x: e.touches[0].clientX + wrapper.scrollLeft, y: e.touches[0].clientY + wrapper.scrollTop }; }
            }, { passive: false });
            wrapper.addEventListener('touchmove', e => {
                if (e.touches.length === 2 && initialPinchDistance) { e.preventDefault(); scale = Math.max(0.3, Math.min(startScale * (getDistance(e.touches[0], e.touches[1]) / initialPinchDistance), 5.0)); queueRenderPage(pageNum); }
                else if (e.touches.length === 1 && isPanning) { e.preventDefault(); wrapper.scrollLeft = panStart.x - e.touches[0].clientX; wrapper.scrollTop = panStart.y - e.touches[0].clientY; }
            }, { passive: false });
            wrapper.addEventListener('touchend', () => { isPanning = false; initialPinchDistance = null; startScale = null; });
            const fileReader = new FileReader();
            fileReader.onload = function() {
                pdfjsLib.getDocument(new Uint8Array(this.result)).promise.then(pdfDoc_ => {
                    pdfDoc = pdfDoc_; controls.querySelector('.page-count').textContent = pdfDoc.numPages;
                    pageNum = 1; renderPage(pageNum); viewerContainer.style.display = 'block';
                    if (callback) callback(file);
                });
            };
            fileReader.readAsArrayBuffer(file);
        }

        // --- GAAR MAP LOGIC ---
        function initGaarMap() {
            if (gaarMap) return; 

            const mapDisplay = document.getElementById('gaar-map-display');
            gaarMap = L.map(mapDisplay).setView([46.2276, 2.2137], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(gaarMap);
            gaarMap.on('click', handleMapClickForManualAdd);
        }

        function initializeGaarMapFromFile(gaarPdfFile) {
            initGaarMap();
        }

        function recreateGaarCircuitsFromState(savedCircuits) {
            if (!gaarMap || !savedCircuits || savedCircuits.length === 0) return;
            clearAllCircuits();

            savedCircuits.forEach(savedCircuit => {
                const newCircuit = {
                    polygon: null,
                    markers: [],
                    cityNames: [],
                    color: savedCircuit.color,
                    isManual: savedCircuit.isManual,
                };
                const circuitIndex = gaarDrawnCircuits.length;

                savedCircuit.points.forEach((point, cityIndex) => {
                    const coord = [point.lat, point.lng];
                    const name = point.name;
                    const marker = createGaarMarker(coord, name, circuitIndex, cityIndex, newCircuit.color);
                    newCircuit.markers.push(marker);
                    newCircuit.cityNames.push(name);
                });

                gaarDrawnCircuits.push(newCircuit);
                updatePolygon(circuitIndex);
            });
            if (gaarDrawnCircuits.length > 0) {
                const allMarkers = gaarDrawnCircuits.flatMap(c => c.markers);
                if (allMarkers.length > 0) {
                    gaarMap.fitBounds(L.featureGroup(allMarkers).getBounds().pad(0.2));
                }
                document.getElementById('gaar-status').textContent = `Affichage de ${gaarDrawnCircuits.length} circuit(s) restauré(s).`;
            }
            updateCircuitControlsVisibility();
        }

        function createGaarMarker(coord, name, circuitIndex, cityIndex, color) {
            const marker = L.circleMarker(coord, { 
                radius: 8,
                fillColor: color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(gaarMap);

            marker.options.circuitIndex = circuitIndex;
            marker.options.cityIndex = cityIndex;
            marker.bindTooltip(name.split(',')[0], { permanent: true, direction: 'top', className: 'gaar-city-label' }).openTooltip();
            marker.bindPopup(() => createPopupContent(name, circuitIndex, cityIndex));
            return marker;
        }

        window.handleGaarPointUpdate = async function(circuitIndex, cityIndex) {
            const input = document.getElementById(`gaar-input-${circuitIndex}-${cityIndex}`);
            const newName = input.value.trim(); if (!newName) return;
            const statusDiv = document.getElementById('gaar-status');
            statusDiv.textContent = `Recherche de "${newName}"...`;
            const geo = await geocodeCity(newName, 1);
            if (geo) {
                const circuit = gaarDrawnCircuits[circuitIndex], marker = circuit.markers[cityIndex];
                marker.setLatLng(geo[0].latlon);
                circuit.cityNames[cityIndex] = newName;
                marker.setTooltipContent(newName.split(',')[0]);
                marker.closePopup();
                updatePolygon(circuitIndex);
                statusDiv.textContent = `Point mis à jour.`;
            } else {
                statusDiv.textContent = `Coordonnées introuvables pour "${newName}".`;
            }
        };
        
        window.handleGaarPointDelete = function(circuitIndex, cityIndex) {
            const circuit = gaarDrawnCircuits[circuitIndex];
            if (!circuit) return;

            const markerToRemove = circuit.markers[cityIndex];
            if (markerToRemove) gaarMap.removeLayer(markerToRemove);
            
            circuit.markers.splice(cityIndex, 1);
            circuit.cityNames.splice(cityIndex, 1);

            circuit.markers.forEach((marker, newIndex) => {
                marker.options.cityIndex = newIndex;
                marker.bindPopup(() => createPopupContent(circuit.cityNames[newIndex], circuitIndex, newIndex));
            });

            if (circuit.markers.length < 2) {
                if (circuit.polygon) gaarMap.removeLayer(circuit.polygon);
                circuit.polygon = null;
                if (circuit.markers.length === 0) {
                     gaarDrawnCircuits[circuitIndex] = null;
                }
            } else {
                updatePolygon(circuitIndex);
            }
            
            const wasCircuitDeleted = gaarDrawnCircuits[circuitIndex] === null;
            if (wasCircuitDeleted) {
                gaarDrawnCircuits = gaarDrawnCircuits.filter(Boolean);
                gaarDrawnCircuits.forEach((c, newCIndex) => {
                     c.markers.forEach(m => {
                        m.options.circuitIndex = newCIndex;
                        m.bindPopup(() => createPopupContent(m.getTooltip().getContent(), newCIndex, m.options.cityIndex));
                    });
                });
            }
            updateCircuitControlsVisibility();
            document.getElementById('gaar-status').textContent = `Point supprimé.`;
        };

        function createPopupContent(name, cIdx, cityIdx) {
            const form = document.createElement('div');
            form.className = 'gaar-popup-form';
            form.innerHTML = `
                <label>Modifier le nom :</label>
                <input type="text" id="gaar-input-${cIdx}-${cityIdx}" value="${name}">
                <button onclick="handleGaarPointUpdate(${cIdx}, ${cityIdx})">OK</button>
                <button class="delete-point-btn" onclick="handleGaarPointDelete(${cIdx}, ${cityIdx})">Supprimer ce point</button>
            `;
            return form;
        }

        function updatePolygon(circuitIndex) {
            const circuit = gaarDrawnCircuits[circuitIndex];
            if (!circuit) return;

            if (circuit.markers.length < 2) {
                if (circuit.polygon) {
                    gaarMap.removeLayer(circuit.polygon);
                    circuit.polygon = null;
                }
                return;
            }

            const latlngs = circuit.markers.map(m => m.getLatLng());
            const hasEnoughPointsForPolygon = latlngs.length >= 3;

            if (circuit.polygon) {
                const isCurrentlyPolygon = circuit.polygon instanceof L.Polygon;

                if (hasEnoughPointsForPolygon && !isCurrentlyPolygon) {
                    gaarMap.removeLayer(circuit.polygon);
                    circuit.polygon = L.polygon(latlngs, { color: circuit.color }).addTo(gaarMap);
                }
                else if (!hasEnoughPointsForPolygon && isCurrentlyPolygon) {
                    gaarMap.removeLayer(circuit.polygon);
                    circuit.polygon = L.polyline(latlngs, { color: circuit.color }).addTo(gaarMap);
                }
                else {
                    circuit.polygon.setLatLngs(latlngs);
                }
            }
            else {
                if (hasEnoughPointsForPolygon) {
                    circuit.polygon = L.polygon(latlngs, { color: circuit.color }).addTo(gaarMap);
                } else {
                    circuit.polygon = L.polyline(latlngs, { color: circuit.color }).addTo(gaarMap);
                }
            }
        }

        async function geocodeCity(name, limit = 1) { try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}&limit=${limit}&countrycodes=fr`); const d=await r.json(); return (d&&d.length>0)?d.map(i=>({name:i.display_name,latlon:[parseFloat(i.lat),parseFloat(i.lon)]})):null;}catch(e){return null;}}
        
        async function reverseGeocode(latlng) {
            const statusDiv = document.getElementById('gaar-status');
            statusDiv.textContent = 'Recherche du nom de la ville...';
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latlng.lat}&lon=${latlng.lng}&zoom=10`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Réponse réseau non OK');
                const data = await response.json();
                const cityName = data.address.city || data.address.town || data.address.village;
                if (cityName) {
                    statusDiv.textContent = `Point ajouté à ${cityName}.`;
                    return cityName;
                } else {
                    statusDiv.textContent = 'Impossible de trouver le nom de la ville, utilisation d\'un nom générique.';
                    return data.display_name ? data.display_name.split(',')[0] : null;
                }
            } catch (error) {
                console.error("Erreur de géocodage inversé:", error);
                statusDiv.textContent = 'Erreur lors de la recherche du nom de la ville.';
                return null;
            }
        }
        
        async function handleMapClickForManualAdd(e) {
            if (!isAddingManualCircuit) return;

            const clickPoint = gaarMap.latLngToContainerPoint(e.latlng);
            const proximityThreshold = 20;

            for (const circuit of gaarDrawnCircuits) {
                for (const marker of circuit.markers) {
                    const markerPoint = gaarMap.latLngToContainerPoint(marker.getLatLng());
                    if (clickPoint.distanceTo(markerPoint) < proximityThreshold) {
                        marker.openPopup();
                        return;
                    }
                }
            }

            let targetCircuit = gaarDrawnCircuits.find(c => c && c.isManual && c.markers.length < 3);

            if (!targetCircuit) {
                const manualCircuitsCount = gaarDrawnCircuits.filter(c => c && c.isManual).length;
                const newCircuitColor = manualCircuitColors[manualCircuitsCount % manualCircuitColors.length];
                
                targetCircuit = {
                    polygon: null,
                    markers: [],
                    cityNames: [],
                    color: newCircuitColor,
                    isManual: true,
                };
                gaarDrawnCircuits.push(targetCircuit);
            }
            
            const circuitIndex = gaarDrawnCircuits.indexOf(targetCircuit);
            const cityIndex = targetCircuit.markers.length;
            const pointName = (await reverseGeocode(e.latlng)) || `Point ${cityIndex + 1}`;
            const newMarker = createGaarMarker(e.latlng, pointName, circuitIndex, cityIndex, targetCircuit.color);
            
            targetCircuit.markers.push(newMarker);
            targetCircuit.cityNames.push(pointName);
            
            updatePolygon(circuitIndex);
            updateCircuitControlsVisibility();
        }

        function updateCircuitControlsVisibility() {
            const deleteBtn = document.getElementById('delete-circuits-btn');
            if (deleteBtn) {
                const hasCircuits = gaarDrawnCircuits.some(c => c && c.markers.length > 0);
                deleteBtn.style.display = hasCircuits ? 'inline-block' : 'none';
            }
        }

        function clearAllCircuits() {
            if (!gaarMap) return;
            gaarDrawnCircuits.forEach(({ polygon, markers }) => {
                if (polygon) gaarMap.removeLayer(polygon);
                if (markers) markers.forEach(m => gaarMap.removeLayer(m));
            });
            gaarDrawnCircuits = [];
            updateCircuitControlsVisibility();
        }

        function resetGaarPdfOnly() {
            gaarFileObject = null;
            document.getElementById('pdf-input-gaar').value = null;
            document.getElementById('pdf-info-gaar').textContent = '';
            document.getElementById('pdf-interactive-container-gaar').style.display = 'none';
            document.getElementById('pdf-load-gaar-btn').style.display = 'inline-block';
            document.getElementById('pdf-reset-gaar-btn').style.display = 'none';
        }
        
        function toggleManualCircuitMode() {
            const btn = document.getElementById('add-manual-circuit-btn');
            const mapContainer = document.getElementById('gaar-map-display');
            isAddingManualCircuit = !isAddingManualCircuit;

            if (isAddingManualCircuit) {
                btn.classList.add('active');
                btn.textContent = "Terminer l'ajout (cliquez ici)";
                mapContainer.classList.add('crosshair-cursor');
            } else {
                btn.classList.remove('active');
                btn.textContent = 'Ajout manuel circuit(s) GAAR';
                mapContainer.classList.remove('crosshair-cursor');
            }
        }

        function initializeGaarMapControls() {
            document.getElementById('add-manual-circuit-btn').addEventListener('click', toggleManualCircuitMode);
            document.getElementById('delete-circuits-btn').addEventListener('click', () => {
                if (gaarDrawnCircuits.length > 0 && confirm("Voulez-vous vraiment supprimer tous les circuits tracés sur la carte ?")) {
                    clearAllCircuits();
                    document.getElementById('gaar-status').textContent = 'Tous les circuits ont été supprimés.';
                }
            });
        }
            
        function initializeInteractivePdfViewers() {
            const createFileHandler = (fileObjectSetter, infoId, viewerId, mapInitFn, initialScale = 1.5) => (files) => {
                const file = files[0];
                if (!file || file.type !== 'application/pdf') return;
                fileObjectSetter(file);
                document.getElementById(infoId).textContent = `Document chargé : ${file.name}`;
                createInteractivePdfHandler(document.getElementById(viewerId), file, mapInitFn, initialScale);
                if (viewerId === 'pdf-interactive-container-gaar') {
                    document.getElementById('pdf-load-gaar-btn').style.display = 'none';
                    document.getElementById('pdf-reset-gaar-btn').style.display = 'inline-block';
                }
            };
            const fdsHandler = createFileHandler(f => fdsFileObject = f, 'pdf-info-fds', 'pdf-interactive-container-fds', null, 1.65);
            const gaarHandler = createFileHandler(f => gaarFileObject = f, 'pdf-info-gaar', 'pdf-interactive-container-gaar', initializeGaarMapFromFile, 1.3);
            const notamHandler = (files) => {
                const file = files[0]; if (!file || file.type !== 'application/pdf') return;
                document.getElementById('pdf-info-notam').textContent = `Document chargé : ${file.name}`;
                extractTextFromPdf(file, document.getElementById('pdf-info-notam')); 
            };
            document.getElementById('pdf-load-fds-btn').addEventListener('click', () => document.getElementById('pdf-input-fds').click());
            document.getElementById('pdf-input-fds').addEventListener('change', (e) => fdsHandler(e.target.files));
            setupDropzone('fds-section', fdsHandler);
            document.getElementById('pdf-load-gaar-btn').addEventListener('click', () => document.getElementById('pdf-input-gaar').click());
            document.getElementById('pdf-input-gaar').addEventListener('change', (e) => gaarHandler(e.target.files));
            setupDropzone('gaar-section', gaarHandler);
            document.getElementById('pdf-reset-gaar-btn').addEventListener('click', resetGaarPdfOnly);
            
            document.getElementById('show-gaar-map-btn').addEventListener('click', () => {
                const mapSection = document.getElementById('gaar-map-section');
                mapSection.style.display = 'block';
                initGaarMap(); 
                document.getElementById('gaar-status').textContent = 'Prêt pour l\'ajout manuel de circuits.';
                mapSection.scrollIntoView({ behavior: 'smooth' });
                document.getElementById('gaar-map-nav-link').style.display = 'block';
            });

            document.getElementById('pdf-load-notam-btn').addEventListener('click', () => document.getElementById('pdf-input-notam').click());
            document.getElementById('pdf-input-notam').addEventListener('change', (e) => notamHandler(e.target.files));
            setupDropzone('notam-pdf-dropzone', notamHandler);
        }
        
        function initializeSupAipLoader() {
            const loadBtn = document.getElementById('pdf-load-sup-aip-btn'), addBtn = document.getElementById('pdf-add-sup-aip-btn');
            const fileInput = document.getElementById('pdf-input-sup-aip'), container = document.getElementById('sup-aip-container');
            loadBtn.addEventListener('click', () => fileInput.click()); addBtn.addEventListener('click', () => fileInput.click());
            container.addEventListener('click', (e) => {
                if (e.target && e.target.matches('.sup-aip-delete-btn')) {
                    const itemToRemove = e.target.closest('.sup-aip-item'), fileName = itemToRemove.dataset.fileName;
                    supAipFileObjects = supAipFileObjects.filter(f => f.name !== fileName); itemToRemove.remove();
                }
            });
            const addSupAipFiles = (files) => {
                if (!files.length) return;
                for (const file of files) {
                    if (file.type !== 'application/pdf' || supAipFileObjects.some(f => f.name === file.name)) continue;
                    supAipFileObjects.push(file);
                    const item = document.createElement('div');
                    item.className = 'sup-aip-item'; item.dataset.fileName = file.name;
                    item.innerHTML = `<h3>${file.name}<button class="sup-aip-delete-btn" title="Supprimer">×</button></h3><div class="interactive-pdf-viewer"><div class="interactive-pdf-controls"><button class="pdf-nav-btn" data-action="prev">Préc.</button><span>Page <span class="page-num">1</span>/<span class="page-count">1</span></span><button class="pdf-nav-btn" data-action="next">Suiv.</button><div class="zoom-controls"><button class="pdf-nav-btn" data-action="zoom-out">-</button><span>Zoom</span><button class="pdf-nav-btn" data-action="zoom-in">+</button></div></div><div class="pdf-canvas-wrapper"><canvas class="pdf-canvas"></canvas></div></div>`;
                    container.appendChild(item);
                    createInteractivePdfHandler(item.querySelector('.interactive-pdf-viewer'), file);
                }
                loadBtn.style.display = 'none'; addBtn.style.display = 'inline-block';
            };
            fileInput.addEventListener('change', (e) => addSupAipFiles(e.target.files));
            setupDropzone('sup-aip-section', addSupAipFiles); window.addSupAipFiles = addSupAipFiles;
        }

        function initializeForeFlightButton() { document.getElementById('foreflight-btn').href = 'foreflightmobile://'; }
        
        async function fileToSavable(file) {
            if (!file) return null;
            return {
                name: file.name,
                type: file.type,
                buffer: await file.arrayBuffer()
            };
        }

        function savableToFile(savable) {
            if (!savable || !savable.buffer) return null;
            return new File([savable.buffer], savable.name, { type: savable.type });
        }

        function initializeSessionManagement() {
            const dbName = 'briefingSessionDB', storeName = 'sessionStore', sessionStatus = document.getElementById('session-status');
            const saveBtnTop = document.getElementById('save-session-btn');
            const saveBtnBottom = document.getElementById('save-session-btn-bottom');
            
            function openDB() { 
                return new Promise((resolve, reject) => { 
                    const r = indexedDB.open(dbName, 1); 
                    r.onerror = (e) => reject("Erreur DB: " + e.target.error); 
                    r.onsuccess = e => resolve(e.target.result); 
                    r.onupgradeneeded = e => e.target.result.createObjectStore(storeName, { keyPath: 'id' }); 
                }); 
            }
            
            async function performSave() {
                if (isSavingSession) return;
                isSavingSession = true;
                saveBtnTop.disabled = true;
                saveBtnBottom.disabled = true;
                sessionStatus.textContent = "Sauvegarde en cours...";
                
                let localDb;
                try {
                    // On ouvre une nouvelle connexion DB à chaque sauvegarde pour éviter les connexions périmées.
                    localDb = await openDB();

                    const checkedNotamIds = [], highlightedNotams = {};
                    document.querySelectorAll('#notam-display .notam-item').forEach(item => {
                        const id = item.dataset.notamId; if (!id) return;
                        if (item.querySelector('.notam-checkbox').checked) checkedNotamIds.push(id);
                        const content = item.querySelector('.notam-text-content').innerHTML;
                        if (content.includes('<mark')) highlightedNotams[id] = content;
                    });
                    
                    const gaarMapState = gaarDrawnCircuits.map(circuit => ({
                        color: circuit.color,
                        isManual: circuit.isManual,
                        points: circuit.markers.map((marker, index) => ({
                            lat: marker.getLatLng().lat,
                            lng: marker.getLatLng().lng,
                            name: circuit.cityNames[index]
                        }))
                    }));

                    const weatherData = {};
                    document.querySelectorAll('.airport-section-container[data-loaded="true"]').forEach(container => {
                        const icao = container.dataset.icao;
                        if (icao) {
                            weatherData[icao] = {
                                metarHTML: container.querySelector('.metar-container').innerHTML,
                                tafHTML: container.querySelector('.taf-container').innerHTML
                            };
                        }
                    });
                
                    const dataToSave = {
                        id: 'currentSession',
                        fds: await fileToSavable(fdsFileObject),
                        gaar: await fileToSavable(gaarFileObject),
                        gaarMapState: gaarMapState,
                        supAips: await Promise.all(supAipFileObjects.map(f => fileToSavable(f))),
                        notamText: document.getElementById('notam-input').value,
                        notamState: { checkedIds: checkedNotamIds, highlights: highlightedNotams },
                        weatherData: weatherData,
                        savedAt: new Date()
                    };

                    const store = localDb.transaction([storeName], 'readwrite').objectStore(storeName);
                    
                    // La méthode .put() est atomique : elle remplace l'ancienne sauvegarde par la nouvelle.
                    // C'est plus sûr qu'un .clear() suivi d'un .add(), car il n'y a pas de risque de perte de données si l'ajout échoue.
                    const request = store.put(dataToSave);

                    request.onsuccess = () => { 
                        const now = new Date();
                        const formattedTime = `${String(now.getHours()).padStart(2, '0')}h${String(now.getMinutes()).padStart(2, '0')}`;
                        sessionStatus.textContent = `Session sauvegardée à ${formattedTime}`; 
                    };
                    request.onerror = (e) => { 
                        sessionStatus.textContent = `Erreur de sauvegarde: ${e.target.error}`; 
                        console.error("Erreur IndexedDB:", e.target.error);
                    };

                } catch (error) {
                    sessionStatus.textContent = `Erreur lors de la sauvegarde: ${error.message}`;
                    console.error("Erreur de sauvegarde :", error);
                } finally {
                    if (localDb) localDb.close(); // On ferme la connexion après usage.
                    isSavingSession = false;
                    saveBtnTop.disabled = false;
                    saveBtnBottom.disabled = false;
                }
            }

            saveBtnTop.addEventListener('click', performSave);
            saveBtnBottom.addEventListener('click', performSave);

            document.getElementById('clear-session-btn').addEventListener('click', async () => {
                if (confirm("Vraiment effacer la session sauvegardée ?")) {
                    let localDb;
                    try { 
                        localDb = await openDB();
                        const request = localDb.transaction([storeName], 'readwrite').objectStore(storeName).clear(); 
                        request.onsuccess = () => {
                            alert("Sauvegarde effacée. Rechargement..."); 
                            location.reload();
                        };
                        request.onerror = (e) => {
                            sessionStatus.textContent = `Erreur: ${e.target.error}`;
                        };
                    }
                    catch (error) { 
                        sessionStatus.textContent = `Erreur: ${error}`; 
                    } finally {
                        if (localDb) localDb.close();
                    }
                }
            });

            (async function loadSession() {
                let db;
                try {
                    db = await openDB(); // Ouvre la connexion pour la lecture initiale
                    const request = db.transaction([storeName], 'readonly').objectStore(storeName).get('currentSession');

                    request.onerror = (e) => {
                         sessionStatus.textContent = `Erreur DB: ${e.target.error}`;
                    };

                    request.onsuccess = e => {
                        const data = e.target.result;
                        if (data) {
                            if (data.fds) {
                                const file = savableToFile(data.fds);
                                fdsFileObject = file;
                                document.getElementById('pdf-info-fds').textContent = `Document chargé : ${file.name}`;
                                createInteractivePdfHandler(document.getElementById('pdf-interactive-container-fds'), file, null, 1.65);
                            }
                            
                            const hasGaarPdf = !!data.gaar;
                            const hasGaarMapState = data.gaarMapState && data.gaarMapState.length > 0;

                            if (hasGaarPdf || hasGaarMapState) {
                                document.getElementById('gaar-map-section').style.display = 'block';
                                initGaarMap();
                                if (hasGaarPdf) {
                                   document.getElementById('pdf-load-gaar-btn').style.display = 'none';
                                }
                                document.getElementById('pdf-reset-gaar-btn').style.display = hasGaarPdf ? 'inline-block' : 'none';
                                document.getElementById('gaar-map-nav-link').style.display = 'block';
                            }
                            
                            if (hasGaarPdf) {
                                const file = savableToFile(data.gaar);
                                gaarFileObject = file;
                                document.getElementById('pdf-info-gaar').textContent = `Document chargé : ${file.name}`;
                                createInteractivePdfHandler(document.getElementById('pdf-interactive-container-gaar'), file, initializeGaarMapFromFile, 1.3);
                            }
                            
                            if (hasGaarMapState) {
                                recreateGaarCircuitsFromState(data.gaarMapState);
                            }

                            if (data.supAips && data.supAips.length > 0) {
                                const files = data.supAips.map(s => savableToFile(s)).filter(Boolean);
                                if (files.length > 0) window.addSupAipFiles(files);
                            }
                            if (data.notamText) {
                                document.getElementById('notam-input').value = data.notamText;
                                if(data.notamText) window.parseAndDisplayNotams(data.notamState || null);
                            }
                             if (data.weatherData) {
                                Object.entries(data.weatherData).forEach(([icao, weather]) => {
                                    let container = document.getElementById(`notam-container-${icao}`);
                                    if (!container) { 
                                        container = createAirportSectionElement(icao, icao);
                                        (document.getElementById('manual-metar-display') || document.getElementById('notam-display')).appendChild(container);
                                    }
                                    container.querySelector('.metar-container').innerHTML = weather.metarHTML;
                                    container.querySelector('.taf-container').innerHTML = weather.tafHTML;
                                    container.dataset.loaded = 'true';
                                });
                                checkWeatherValidity();
                            }
                            sessionStatus.textContent = `Session restaurée (du ${new Date(data.savedAt).toLocaleString('fr-FR')})`;
                        } else {
                            sessionStatus.textContent = "Aucune session sauvegardée.";
                        }
                    };
                } catch (error) { 
                    sessionStatus.textContent = `Erreur DB: ${error}`; 
                } finally {
                    if (db) db.close(); // On ferme la connexion après la lecture/écriture
                }
            })();
        }
        
        async function extractTextFromPdf(file, pdfInfoElement) { 
            const notamInput = document.getElementById('notam-input'); 
            pdfInfoElement.textContent = `Extraction du texte de ${file.name}...`; 
            try { 
                const fileReader = new FileReader(); 
                fileReader.readAsArrayBuffer(file); 
                await new Promise((resolve, reject) => { fileReader.onload = resolve; fileReader.onerror = reject; }); 
                const pdf = await pdfjsLib.getDocument({ data: fileReader.result }).promise; 
                let fullText = ''; 
                for (let i = 1; i <= pdf.numPages; i++) { 
                    const page = await pdf.getPage(i); 
                    const textContent = await page.getTextContent(); 
                    let lastY = -1;
                    textContent.items.forEach(item => {
                        if (lastY !== -1 && item.transform[5] < lastY - 5) fullText += '\n';
                        fullText += item.str;
                        lastY = item.transform[5];
                    });
                    fullText += '\n\n';
                } 
                notamInput.value = fullText.trim().replace(/Page\s+\d+\s+of\s+\d+/g, ''); 
                pdfInfoElement.textContent = `Texte extrait de ${file.name}.`; 
                window.parseAndDisplayNotams();
            } catch (error) { 
                console.error("Erreur d'extraction PDF:", error); 
                pdfInfoElement.textContent = "Erreur d'extraction du texte du PDF."; 
                let detailedMessage = "Impossible d'extraire le texte de ce PDF.\n\n";
                if (error.name === 'PasswordException' || (error.message && error.message.toLowerCase().includes('password'))) {
                    detailedMessage += "Raison probable : Le fichier est protégé par un mot de passe.";
                } else {
                    detailedMessage += "Raison probable : Le fichier est corrompu, vide, ou dans un format non supporté.";
                }
                detailedMessage += "\n\nDétail technique : " + error.message;
                alert(detailedMessage + "\n\nVous pouvez toujours le copier/coller manuellement.");
            } 
        }
        
        function generateNotamPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;
            const margin = 10;
            const pageHeight = doc.internal.pageSize.getHeight();
            const usableWidth = doc.internal.pageSize.getWidth() - 2 * margin;

            const airportSections = document.querySelectorAll('#notam-display .airport-section-container');
            const visibleNotamsExist = Array.from(airportSections).some(section => section.querySelector('.notam-item:not(.hidden-by-filter):not(.hidden-by-prefilter)'));

            if (!visibleNotamsExist) {
                alert("Aucun NOTAM sélectionné à sauvegarder.");
                return;
            }

            doc.setFont("helvetica", "bold").setFontSize(18).text("Sélection de NOTAMs", doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
            y += 7;
            const today = new Date();
            doc.setFont("helvetica", "normal").setFontSize(10).text(`Généré le ${today.toLocaleDateString('fr-FR')} à ${today.toLocaleTimeString('fr-FR')}`, doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
            y += 15;

            airportSections.forEach(section => {
                const visibleItems = section.querySelectorAll('.notam-item:not(.hidden-by-filter):not(.hidden-by-prefilter)');
                if (visibleItems.length === 0) return;
                if (y > pageHeight - 20) { doc.addPage(); y = 15; }
                const airportTitle = section.querySelector('h3').textContent.replace(/Afficher TAF/g, '').replace(/Masquer TAF/g, '').trim();
                doc.setFont("helvetica", "bold").setFontSize(14).text(airportTitle, margin, y);
                y += 8;

                visibleItems.forEach(item => {
                    if (y > pageHeight - 30) { doc.addPage(); y = 15; }
                    const validityEl = item.querySelector('.notam-validity');
                    if (validityEl) {
                        doc.setFont("helvetica", "bolditalic").setFontSize(8).setTextColor(50);
                        const validityLines = doc.splitTextToSize(validityEl.textContent, usableWidth - 5);
                        doc.text(validityLines, margin + 5, y);
                        y += validityLines.length * 3.5;
                    }
                    doc.setFont("helvetica", "normal").setFontSize(9).setTextColor(0);
                    const notamText = (item.querySelector('.notam-text-content')).innerText;
                    const notamLines = doc.splitTextToSize(notamText, usableWidth - 5);
                    doc.text(notamLines, margin + 5, y);
                    y += notamLines.length * 4 + 5;
                });
            });
            
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
        }

        function checkWeatherValidity() {
            const now = new Date();

            // Check METARs
            document.querySelectorAll('.metar-container').forEach(container => {
                const pre = container.querySelector('pre');
                if (!pre) return;
                const metarText = pre.textContent;
                const h4 = container.querySelector('h4');

                let ageSpan = h4.querySelector('.metar-age-display');
                if (!ageSpan) {
                    ageSpan = document.createElement('span');
                    ageSpan.className = 'metar-age-display';
                    h4.appendChild(ageSpan);
                }
                
                const oldWarning = h4.querySelector('.weather-validity-warning');
                if (oldWarning) oldWarning.remove();

                const timeMatch = metarText.match(/(\d{2})(\d{2})(\d{2})Z/);

                if (timeMatch) {
                    const day = parseInt(timeMatch[1], 10);
                    const hour = parseInt(timeMatch[2], 10);
                    const minute = parseInt(timeMatch[3], 10);
                    const metarDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), day, hour, minute));
                    if (metarDate > now) {
                        metarDate.setUTCMonth(metarDate.getUTCMonth() - 1);
                        if (metarDate > now) {
                           metarDate.setUTCFullYear(metarDate.getUTCFullYear() - 1);
                        }
                    }
                    const ageInMinutes = (now.getTime() - metarDate.getTime()) / 60000;
                    
                    ageSpan.textContent = `${Math.round(ageInMinutes)} min`;
                    ageSpan.style.color = (ageInMinutes <= 35) ? '#28a745' : 'var(--sc-red)';

                } else {
                    ageSpan.textContent = '';
                }
            });

            // Check TAFs
            document.querySelectorAll('.taf-container').forEach(container => {
                const pre = container.querySelector('pre');
                if (!pre) return;
                const tafText = pre.textContent;
                const validityMatch = tafText.match(/(\d{2})\d{4}Z\s+\d{2}(\d{2})\/(\d{2})(\d{2})/);
                const h4 = container.querySelector('h4');
                let warningSpan = h4.querySelector('.weather-validity-warning');

                if (validityMatch) {
                    const issueDay = parseInt(validityMatch[1], 10);
                    const endDay = parseInt(validityMatch[3], 10);
                    const endHour = parseInt(validityMatch[4], 10);

                    const expiryDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), endDay, endHour, 0));
                    
                    if (endDay < issueDay) {
                        expiryDate.setUTCMonth(expiryDate.getUTCMonth() + 1);
                    }
                    
                    const isExpired = now > expiryDate;
                    if (isExpired) {
                        if (!warningSpan) {
                            warningSpan = document.createElement('span');
                            warningSpan.className = 'weather-validity-warning';
                            h4.appendChild(warningSpan);
                        }
                        warningSpan.textContent = `TAF non à jour`;
                    } else if (warningSpan) {
                        warningSpan.remove();
                    }
                } else if (warningSpan) {
                    warningSpan.remove();
                }
            });
        }

        function initializeNotamParser() { 
            const notamInput = document.getElementById('notam-input'), notamDisplay = document.getElementById('notam-display'), notamSection = document.querySelector('.notam-section');
            const filterButtons = document.querySelectorAll('.filter-action'), showAllButtons = document.querySelectorAll('.show-all-action'), savePdfButtons = document.querySelectorAll('.save-pdf-action');
            const predefinedIcaoOrder = ['LFTW', 'LFML', 'LFTH', 'LFMD', 'LFHO', 'LFLU', 'LFMH', 'LFMU', 'LFMP', 'LFMK', 'LFCC', 'LFBD', 'LFBL', 'LFBM', 'LFBP', 'LFKC', 'LFKB', 'LFKJ', 'LFKF', 'LFJR', 'LFAQ', 'LFLX', 'LFSG', 'LFRV'];
            const icaoToFullName = {
                'LFTW':'LFTW - NIMES GARONS', 'LFML':'LFML - MARSEILLE PROVENCE', 'LFTH':'LFTH - TOULON HYERES', 
                'LFMD':'LFMD - CANNES MANDELIEU', 'LFHO':'LFHO - AUBENAS ARDECHE MERIDIONALE', 'LFLU':'LFLU - VALENCE CHABEUIL', 
                'LFMH':'LFMH - ST ETIENNE BOUTHEON', 'LFMU':'LFMU - BEZIERS VIAS', 'LFMP':'LFMP - PERPIGNAN RIVESALTES', 
                'LFMK':'LFMK - CARCASSONNE SALVAZA', 'LFCC':'LFCC - CAHORS LALBENQUE', 'LFBD':'LFBD - BORDEAUX MERIGNAC', 
                'LFBL':'LFBL - LIMOGES BELLEGARDE', 'LFBM':'LFBM - MONT DE MARSAN', 'LFBP':'LFBP - PAU PYRENEES', 
                'LFKC':'LFKC - CALVI STE CATHERINE', 'LFKB':'LFKB - BASTIA PORETTA', 'LFKJ':'LFKJ - AJACCIO NAPOLEON BONAPARTE', 
                'LFKF':'LFKF - FIGARI SUD CORSE', 'LFJR':'LFJR - ANGERS LOIRE', 
                'LFAQ':'LFAQ - ALBERT BRAY', 
                'LFLX':'LFLX - CHATEAUROUX DEOLS', 'LFSG':'LFSG - EPINAL MIRECOURT', 'LFRV':'LFRV - VANNES GOLFE DU MORBIHAN'
            };
            const keywordsToFilter = [
                'aerodrome administration', 'animal', 'avgas 100ll', 'crane', 'dme', 'drill', 
                'fato', 'grf', 'handling', 'lights', 'model flying', 'night parachuting', 
                'obst', 'obstacle', 'obstacles', 'police', 'radar', 'rffs', 'telescopic', 'trees', 
                'unpaved', 'vor', 'wig wag'
            ];

            const manualLoadWeatherBtn = document.getElementById('manual-load-weather-btn');
            if (manualLoadWeatherBtn) {
                manualLoadWeatherBtn.addEventListener('click', () => {
                    const airportContainers = document.querySelectorAll('#notam-display .airport-section-container');
                    airportContainers.forEach(container => {
                        const icao = container.dataset.icao;
                        if (icao) {
                            fetchAndDisplayWeather(icao, container);
                        }
                    });
                });
            }

            function setupKeywordFilterDropdown() {
                const filterListContainer = document.getElementById('keyword-filter-list');
                const toggleBtn = document.getElementById('keyword-filter-toggle-btn');
                filterListContainer.innerHTML = '';
                
                keywordsToFilter.forEach(keyword => {
                    const id = `filter-cb-${keyword.replace(/\s+/g, '-')}`;
                    const label = document.createElement('label');
                    label.htmlFor = id;
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = id;
                    checkbox.dataset.keyword = keyword;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', applyLiveFilters);

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(keyword.toUpperCase()));
                    filterListContainer.appendChild(label);
                });

                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    filterListContainer.style.display = filterListContainer.style.display === 'block' ? 'none' : 'block';
                });

                window.addEventListener('click', (e) => {
                    if (!toggleBtn.contains(e.target) && !filterListContainer.contains(e.target)) {
                        filterListContainer.style.display = 'none';
                    }
                });
            }

            function renderInitialAirportSections() {
                notamDisplay.innerHTML = ''; 
                predefinedIcaoOrder.forEach(icao => {
                    const fullName = icaoToFullName[icao] || `${icao} - INCONNU`;
                    const airportContainer = createAirportSectionElement(icao, fullName);
                    notamDisplay.appendChild(airportContainer);
                });
            }

            function applyLiveFilters() {
                const isDateFilterActive = document.getElementById('notam-date-filter-cb').checked;
                const activeKeywords = Array.from(document.querySelectorAll('#keyword-filter-list input:checked')).map(cb => cb.dataset.keyword);
                
                const today = new Date();
                const todayStart = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate(), 0, 0, 0));
                const todayEnd = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate(), 23, 59, 59));

                document.querySelectorAll('#notam-display .notam-item').forEach(item => {
                    let shouldBeHidden = false;
                    
                    if (isDateFilterActive) {
                        const notamStart = item.dataset.startDate ? new Date(item.dataset.startDate) : null;
                        const notamEnd = item.dataset.endDate ? new Date(item.dataset.endDate) : null;
                        if (notamStart && notamEnd && !(notamStart <= todayEnd && notamEnd >= todayStart)) {
                            shouldBeHidden = true;
                        }
                    }

                    if (activeKeywords.length > 0 && !shouldBeHidden) {
                        const itemText = item.textContent;
                        if (activeKeywords.some(k => {
                            const regex = new RegExp(`\\b${k.replace(/ /g, '\\s')}\\b`, 'i');
                            return regex.test(itemText);
                        })) {
                            shouldBeHidden = true;
                        }
                    }
                    item.classList.toggle('hidden-by-prefilter', shouldBeHidden);
                });
            }

            window.parseAndDisplayNotams = function(savedState = null) {
                const rawText = notamInput.value; if (!rawText.trim()) return;
                const airportSections = rawText.split(/\n\s*(?=LF[A-Z]{2}\s+-\s+)/);
                const airportsData = {};
                airportSections.forEach(section => {
                    const lines = section.trim().split('\n'), header = lines.shift() || "";
                    if (!header.match(/^LF[A-Z]{2}\s+-\s+/)) return;
                    if (header.includes("No information received")) { airportsData[header] = [header]; return; }
                    
                    let content = lines.join('\n').replace(/Page \d+ of \d+\s*\n?/gi, '');
                    const notamBlocks = content.split(/(?=Q\))/g).filter(b => b.trim().startsWith('Q)'));
                    
                    let currentNotamNumber = '';
                    const processedBlocks = [];

                    content.split('\n').forEach(line => {
                        const notamNumberMatch = line.match(/([A-Z]\d{4}\/\d{2})$/);
                        if(notamNumberMatch) {
                            currentNotamNumber = notamNumberMatch[1];
                        }
                        if(line.startsWith('Q)')) {
                            processedBlocks.push(line.trim() + ' ' + currentNotamNumber);
                        } else if (processedBlocks.length > 0) {
                            processedBlocks[processedBlocks.length-1] += '\n' + line;
                        }
                    });

                    airportsData[header] = processedBlocks;
                });
                
                Object.keys(airportsData).forEach(airportName => {
                    const icao = airportName.split(' ')[0];
                    let container = document.getElementById(`notam-container-${icao}`);
                    if (!container) {
                        const fullName = icaoToFullName[icao] || airportName;
                        container = createAirportSectionElement(icao, fullName);
                        notamDisplay.appendChild(container);
                    }
                    container.querySelectorAll('.notam-item').forEach(item => item.remove());
                    const tafContainer = container.querySelector('.taf-container');
                    (airportsData[airportName] || []).forEach(notamText => {
                        const notamEl = createNotamItemElement(notamText, icao);
                        tafContainer.insertAdjacentElement('afterend', notamEl);
                    });
                });
                
                applyLiveFilters();

                const controlsVisible = document.querySelectorAll('.notam-item').length > 0;
                document.getElementById('notam-controls-top').style.display = controlsVisible ? 'flex' : 'none';
                document.getElementById('notam-controls-bottom').style.display = controlsVisible ? 'flex' : 'none';
                
                if (savedState) {
                    if (savedState.highlights) Object.entries(savedState.highlights).forEach(([id, html]) => { const item = document.querySelector(`[data-notam-id="${id}"]`); if (item) item.querySelector('.notam-text-content').innerHTML = html; });
                    if (savedState.checkedIds) savedState.checkedIds.forEach(id => { const item = document.querySelector(`[data-notam-id="${id}"]`); if (item) item.querySelector('.notam-checkbox').checked = true; });
                    if (savedState.checkedIds && savedState.checkedIds.length > 0) applySelectionFilter();
                }
            }
            
            function applySelectionFilter() {
                document.querySelectorAll('.notam-item').forEach(item => item.classList.toggle('hidden-by-filter', !item.querySelector('.notam-checkbox').checked));
                filterButtons.forEach(btn => btn.style.display = 'none');
                showAllButtons.forEach(btn => btn.style.display = 'inline-block');
                savePdfButtons.forEach(btn => btn.style.display = 'inline-block');
                
                const visibleNotams = document.querySelectorAll('#notam-display .notam-item:not(.hidden-by-filter):not(.hidden-by-prefilter)');
                if (visibleNotams.length > 0) {
                    const lastVisibleNotam = visibleNotams[visibleNotams.length - 1];
                    lastVisibleNotam.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'nearest' });
                }
            }

            function resetSelectionFilter() {
                document.querySelectorAll('.hidden-by-filter').forEach(item => item.classList.remove('hidden-by-filter'));
                showAllButtons.forEach(btn => btn.style.display = 'none');
                savePdfButtons.forEach(btn => btn.style.display = 'none');
                filterButtons.forEach(btn => btn.style.display = 'inline-block');
            }
            
            setupKeywordFilterDropdown();
            renderInitialAirportSections();
            (document.getElementById('notam-parse-btn') || {}).addEventListener('click', () => window.parseAndDisplayNotams());
            filterButtons.forEach(b => b.addEventListener('click', applySelectionFilter));
            showAllButtons.forEach(b => b.addEventListener('click', resetSelectionFilter));
            savePdfButtons.forEach(b => b.addEventListener('click', generateNotamPdf));
            document.getElementById('notam-date-filter-cb').addEventListener('change', applyLiveFilters);

            notamSection.addEventListener('click', async (e) => {
                const t = e.target;
                if (t.matches('.sup-aip-link')) { e.preventDefault(); window.open(t.href, '_blank'); return; }
                
                if (t.matches('.taf-toggle-btn')) {
                    const airportContainer = t.closest('.airport-section-container');
                    const tafContainer = airportContainer.querySelector('.taf-container');
                    const isHidden = tafContainer.style.display === 'none';
                    tafContainer.style.display = isHidden ? 'block' : 'none';
                    t.textContent = isHidden ? 'Masquer TAF' : 'Afficher TAF';
                }

                if (t.matches('.metar-taf-refresh-btn')) {
                    const airportContainer = t.closest('.airport-section-container');
                    const icao = airportContainer.dataset.icao;
                    if(icao) await fetchAndDisplayWeather(icao, airportContainer);
                }

                const mark = t.closest('mark.highlighted-text'); if(mark && !window.getSelection().toString()) { const p = mark.parentNode; while(mark.firstChild) p.insertBefore(mark.firstChild, mark); p.removeChild(mark); p.normalize(); }
            });

            function handleTextHighlight(event) {
                const textContentDiv = event.target.closest('.notam-text-content'); if (!textContentDiv) return;
                setTimeout(() => {
                    const selection = window.getSelection(); if (!selection || selection.isCollapsed || !textContentDiv.contains(selection.anchorNode)) return;
                    const range = selection.getRangeAt(0);
                    if (event.type !== 'touchend' && !event.ctrlKey) {
                        textContentDiv.querySelectorAll('mark.highlighted-text').forEach(h => { const p = h.parentNode; while (h.firstChild) p.insertBefore(h.firstChild, h); p.removeChild(h); });
                        textContentDiv.normalize();
                    }
                    const newSelection = window.getSelection(); if (newSelection.isCollapsed) return;
                    const newRange = newSelection.getRangeAt(0);
                    const mark = document.createElement('mark'); mark.className = 'highlighted-text';
                    try { newRange.surroundContents(mark); } catch (e) { console.warn("Surlignage impossible.", e); }
                    newSelection.removeAllRanges();
                }, 10);
            }
            notamSection.addEventListener('mouseup', handleTextHighlight);
            notamSection.addEventListener('touchend', handleTextHighlight);
        }
        
        function initializeManualMetarFetch() {
            const fetchBtn = document.getElementById('manual-metar-fetch-btn'), input = document.getElementById('manual-icao-input'), display = document.getElementById('manual-metar-display');
            const handleFetch = () => {
                const icaos = input.value.trim().toUpperCase().split(/\s+/).filter(Boolean); if (!icaos.length) return;
                display.innerHTML = '';
                icaos.forEach(icao => {
                    const airportContainer = createAirportSectionElement(icao, icao);
                    display.appendChild(airportContainer);
                    fetchAndDisplayWeather(icao, airportContainer);
                });
            };
            fetchBtn.addEventListener('click', handleFetch);
            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleFetch(); } });
        }

        function initializePageTitle() {
            const titleElement = document.getElementById('main-title');
            titleElement.textContent = `Briefing Fdf du ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;
            const timeDisplay = document.getElementById('current-time-display');
            const updateTime = () => timeDisplay.textContent = new Date().toLocaleTimeString('fr-FR');
            updateTime(); setInterval(updateTime, 1000);
        }

        function getLabelForDate(d){const a=new Date(Date.UTC((new Date).getUTCFullYear(),(new Date).getUTCMonth(),(new Date).getUTCDate())),t=new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())),e=Math.round((t-a)/864e5);return 0===e?"Aujourd'hui":1===e?"Demain":-1===e?"Hier":e>1?`Dans ${e} jours`:`Il y a ${-e} jours`}
    </script>
</body>
</html>
